# AMP Service worker
AMP service worker is a service worker library for your AMP pages.

The project aims to bring network resiliency and more to any AMP page which is being controlled by this service worker.
Core use cases:
- Cache AMP scripts with a `stale-while-revalidate` strategy for a longer duration that http-headers.
- Cache valid visited AMP documents, and serve only in case of flaky network conditions.
- Cache assets which are critical to a page with a given stategy.
- Prefetch outgoing linksfrom an AMP page.
- Cache an offline page in order to show when a user navigates to a page which was previously not visited.


## Usage
In order to use this library user can include the library with an importScript in their service worker

```
importScript('https://cdn.ampproject.org/amp-sw.js');
AMP_SW.init({});
```

## Modules
AMP service worker is made up of multiple modules that help it achieve the above said functionality

1. Amp Caching - [Mandatory]
This is a required module for every service worker generated by us and cannot be opted out. This provides a caching for AMP resources, which mainly includes the unversioned/versioned jS binaries that we deploy as part of AMP deployment.
The AMP deployed binaries and their caching strategies will be as follows:

- Unversioned
These are the binaries which the publishers are required to add in their AMP documents and have no {rtv} numbers in their path. E.g. https://cdn.ampproject.org/v0.js
Since these files are not cached for a long time and are always referred by the same path, its best suited for the service worker to cache these files with a stale-while-revalidate strategy where every request to these resources will respond from cache and fetch a new copy to update the cache.

  __Cache purge:__
These files have a default cache period of 5 minutes, but in order to provide network resiliency, we will allow these files to stay for a day and be updated with staleWhileRevalidate.

- Versioned
	The files that are referred with the {rtv} version in their path can be safely assumed to be
Immutable forever and thus makes a clear sense to have them cache-first strategy. As these resources never change so any copy once stored in the cache does not need to be updated ever.

  __Cache purge:__
These files will be cached for a max life of 14 days, as AMP deploys a new set of files every week. So all older entries will be purged with a grace period of 7 days.


2. Document Caching - [Mandatory]
This module is responsible for caching publisher’s AMP document.
By default, all AMP documents will be cached with a network-first strategy as this will ensure the freshness of the document is never hampered by the presence of the service worker. In order to not make the service worker boot time a perf bottleneck, we’ll enable the Navigation-Preload option for all our service workers

3. Asset Caching - [Optional]
This is an optional module, which the publisher can use to tell us about the assets that are important for a page’s completeness. These can be static assets like images and more but not an HTML file as it might conflict with a navigation route.
These assets will be cached with one of the three caching strategies(STALE WHILE REVALIDATE, CACHE FIRST, NETWORK FIRST). A maximum of 25 such assets can be saved with this module.

In case the publisher wants NETWORK ONLY for any of the assets, they can specify the RegExp for the same in a denyList option.

4. Prefetch outgoing links - [Optional]
This will be an optional module which the publisher can opt into and express their will to prefetch any outgoing same-origin links from their AMP pages, thus increasing the performance for the user when navigation from an AMP page to a NON AMP page.
The links can be opted in by adding in `data-rel=prefetch` to the `<a>` tags.

5. Offline module - [Optional]
This module will let the publisher specify an offline page which is to be shown in case the user navigates to page which wa not previously visited.